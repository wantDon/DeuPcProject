<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
            crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.0/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>
<body>
<th:block th:fragment="deupcRight_Tab">
    <div class="right-tab bg-secondary p-0"
         style="background-color: #BD75C3 !important; width: 5%; height: 100vh; float: right;">
        <div class="btn-group-vertical" role="group" aria-label="Vertical button group" style="width: 100%;">
            <button type="button" class="btn btn-secondary group1-btn"
                    style="background-color: #BD75C3; color: white; height: 150px; display: flex; align-items: center; justify-content: center; position: relative;"
                    onclick="changeButtonStyle(this, '#BD75C3', '#815085');">주문<span id="orderNum" class="orderNum"
                                                                                     style="font-weight: bold; position: absolute; align-items: center; top: 47px; right: 18px; width: 20px; height: 20px; background-color: red; border-radius: 50%;">0</span>
            </button>
            <button type="button" class="btn btn-secondary group1-btn"
                    style="background-color: #BD75C3; color: white; height: 150px; display: flex; align-items: center; justify-content: center;"
                    onclick="changeButtonStyle(this, '#BD75C3', '#815085'), navigateToNoticePage()">공지
            </button>
            <button type="button" class="btn btn-secondary group1-btn"
                    style="background-color: #BD75C3; color: white; height: 150px; display: flex; align-items: center; justify-content: center;"
                    onclick="changeButtonStyle(this, '#BD75C3', '#815085')">재고
            </button>
            <button type="button" class="btn btn-secondary group2-btn"
                    style="background-color: gray; color: white; height: 150px; display: flex; align-items: center; justify-content: center; margin-top: 170px;"
                    onclick="changeButtonStyle(this, 'gray', '#f8f9fa'); navigateToSellPage()">판매현황
            </button>
            <button type="button" class="btn btn-secondary group2-btn"
                    style="background-color: gray; color: white; height: 150px; display: flex; align-items: center; justify-content: center;"
                    onclick="changeButtonStyle(this, 'gray', '#f8f9fa')">판매취소
            </button>
        </div>
    </div>
    <script type="text/javascript">
        $(document).ready(function() {

            getOrderCount();

            var socket = new SockJS('/ws'); // WebSocket 서버 URL
            var stompClient = Stomp.over(socket);

            stompClient.connect({}, function() {
                stompClient.subscribe('/topic/order', function(message) {
                    if (message.body.includes("success")) {
                        location.reload();
                    }
                });
            });
        });

        function getOrderCount() {
            $.ajax({
                url: '/pc/admin/order',
                type: 'POST',
                success: function(response) {
                    if (response.error) {
                        alert(response.error);
                    } else {
                        const orderList = groupByPayNum(response.orderList);
                        document.getElementById("orderNum").textContent = orderList.length;
                    }
                },
                error: function() {
                    $('#result').empty();
                    alert('서버 요청에 실패했습니다. 잠시 후 다시 시도 해주세요.');
                }
            });
        }

        function groupByPayNum(data) {
            const groupedData = data.reduce((acc, current) => {
                const { pay_num, pay_date, pay_req, food_name, order_count, id, pcnum } = current;
                if (!acc[pay_num]) {
                    acc[pay_num] = {
                        pay_num,
                        pay_date,
                        pay_req,
                        id,
                        pcnum,
                        food_items: {}
                    };
                }
                if (!acc[pay_num].food_items[food_name]) {
                    acc[pay_num].food_items[food_name] = order_count;
                } else {
                    acc[pay_num].food_items[food_name] += order_count;
                }
                return acc;
            }, {});
            return Object.values(groupedData).sort((a, b) => new Date(b.pay_date) - new Date(a.pay_date));
        }

        function changeButtonStyle(button, defaultColor, activeColor) {
            var allButtons = document.querySelectorAll('.btn-group-vertical .btn');
            allButtons.forEach(function(btn) {
                btn.classList.remove('active');
                if (btn.style.backgroundColor === activeColor) {
                    btn.style.backgroundColor = defaultColor;
                    btn.style.color = 'white';
                } else {
                    btn.style.backgroundColor = btn.classList.contains('group1-btn') ? '#BD75C3' : 'gray';
                    btn.style.color = 'white';
                }
            });
            button.classList.add('active');
            button.style.backgroundColor = activeColor;
            button.style.color = 'black';
        }

        function navigateToNoticePage() {
            window.location.href = '/notice/'; // 공지 페이지로 이동
        }
        function navigateToFoodPage() {
            window.location.href = '/food'; // 상품 등록 페이지로 이동
        }
        function navigateToSellPage() {
            window.location.href = '/sell'; // 판매 현황 페이지로 이동
        }
    </script>
</th:block>
</body>
</html>