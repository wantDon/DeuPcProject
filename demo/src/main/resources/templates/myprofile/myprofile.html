<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
		<meta name="description" content="" />
		<meta name="author" content="" />
	
		<title>DEU PC - 마이페이지</title>

		<link href="assets/css/myprofile_styles.css" rel="stylesheet" />
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">		
		<script type="text/javascript" src="/assets/js/top.js"></script>
		<script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
		<style>
			.img-fluid {
				width: 100px;
				height: 100px;
			}
			.passwordchk {
				width: 120px; /* 버튼의 고정 너비 */
				height: 50px; /* 버튼의 고정 높이 */
				margin: 3px; /* 버튼 간격 */
				background-color: #BD75C3;
				color: white;
			}
			.password-modal {
				display: none; /* Initially hide the modal */
				position: fixed; /* Stay in place */
				z-index: 1; /* Sit on top */
				left: 0;
				top: 0;
				width: 100%; /* Full width */
				height: 100%; /* Full height */
				overflow: auto; /* Enable scroll if needed */
				background-color: rgb(0,0,0); /* Fallback color */
				background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
			}
			.password-modal-content {
				background-color: #fefefe;
				margin: 15% auto; /* 15% from the top and centered */
				padding: 20px;
				border: 1px solid #888;
				width: 80%; /* Could be more or less, depending on screen size */
			}
			.btn-primary{
				background-color: #BD75C3;
				color: white;
				border-color: #BD75C3;
			}
			.btn-primary:hover {
				background-color: white;
				color: black;
				border-color: #BD75C3;
			}
		</style>
	</head>
	<body>
	<th:block th:replace="~{layout/top::top_main}"></th:block>
	<section class="py-1">
		<div class="container text-center">
			<div class="row justify-content-center">
				<div class="col-lg-6">
					<th:block th:unless="${user.id.contains('비회원')}">
						<div class="text-center border p-4">
							<p class="text-black mb-0">닉네임: <span id="username" th:text="${user.name}"></span></p>
							<p class="mb-0">아이디: <span id="id" th:text="${user.id}"></span> </p>
							<p class="mb-0">이메일 : <span id="user_email" th:text="${user.email}"></span></p>
							<p class="mb-0">생년월일: <span id="user_birth" th:text="${user.birth}"></span> </p>
							<p class="mb-0">전화번호: <span id="user_phone" th:text="${user.phone}"></span></p>
							<p class="mb-0">---------------------------------------------</span></p>
							<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#passwordModal">비밀번호 변경</button>
						</div>						
					</th:block>
				</div>
			</div>
		</div>
	</section>
	
	<!-- Order History Section -->
	<section class="py-2">
		<div class="container">
			<h1 class="mt-3">주문 내역</h1>
			<table class="table table-striped" id="orderHistory">
				<thead>
					<tr align="center">
						<th>주문 일자</th>
						<th>주문 상품</th>
						<th>총 가격</th>
						<th>결제 수단</th>
					</tr>
				</thead>
				<tbody>
					<tr th:each="entry : ${userOrders}" align="center">
						<td th:text="${entry.key}"></td>
						<td>
							<span th:each="payment : ${entry.value}">
							<span th:text="${payment.food_name}"></span>
						</span>
						</td>
						<td>
							<span th:text="${entry.value[0].total_price}"></span>
						</td>
						<td>
							<span th:text="${entry.value[0].method}"></span>
						</td>
					</tr>
				</tbody>
			</table>
		
			<nav aria-label="Page navigation">
				<ul class="pagination justify-content-center">
					<li class="page-item disabled">
						<a class="page-link" href="#" tabindex="-1" aria-disabled="true">&laquo;</a>
					</li>
					<li class="page-item"><a class="page-link" href="#">1</a></li>
					<li class="page-item"><a class="page-link" href="#">2</a></li>
					<li class="page-item"><a class="page-link" href="#">3</a></li>
					<li class="page-item">
						<a class="page-link" href="#">&raquo;</a>
					</li>
				</ul>
			</nav>
		</div>
	</section>
	
	<div class="modal fade" id="passwordModal" tabindex="-1" aria-labelledby="passwordModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="passwordModalLabel">비밀번호 변경</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<input type="password" id="pwd" class="form-control mb-3" placeholder="새 비밀번호" />
					<input type="password" id="pwd1" class="form-control mb-3" placeholder="새 비밀번호 확인" />
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
					<button type="button" class="btn btn-primary" onclick="changePassword()">변경</button>
				</div>
			</div>
		</div>
	</div>
	
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
	
	<script th:inline="javascript">
		function showPasswordModal() {
		document.getElementById("passwordModal").style.display = "block";
		}
		
		function hidePasswordModal() {
		document.getElementById("passwordModal").style.display = "none";
		}
		
		// 변경된 JavaScript 코드에서 사용자 ID를 직접 사용
		function changePassword() {
		var pwd = document.getElementById("pwd").value;
		var pwd1 = document.getElementById("pwd1").value;
		 var id = document.getElementById("id").textContent.trim();
		// 직접 설정한 JavaScript 변수를 사용하여 사용자 ID를 가져옴
		
		if (pwd !== pwd1) {
		alert("Passwords do not match");
		return;
		}
		var jsonData = {
		newPassword: pwd,
		userId: id
		};
		
		$.ajax({
		url: "/myprofile/update-password",
		type: "post",
		contentType: "application/json",
		dataType: "json",
		data: JSON.stringify(jsonData),
		success: function(data) {
		if(data.success) {
		alert("Password changed successfully");
		location.reload();
		} else {
		alert("Failed to change password");
		console.log('failed');
		}
		},
		error: function(xhr){
		console.log(xhr);
		}
		});
		}
		
		
		// Pagination logic
		document.addEventListener('DOMContentLoaded', function() {
		var table = document.getElementById('orderHistory');
		var rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
		var rowsPerPage = 20;
		var currentPage = 1;
		var totalPages = Math.ceil(rows.length / rowsPerPage);
		
		function showPage(page) {
		for (var i = 0; i < rows.length; i++) {
		rows[i].style.display = (i >= (page - 1) * rowsPerPage && i < page * rowsPerPage) ? '' : 'none';
		}
		}
		
		function setupPagination() {
		var pagination = document.querySelector('.pagination');
		pagination.innerHTML = '';
		
		var prev = document.createElement('li');
		prev.className = 'page-item';
		prev.innerHTML = '<a class="page-link" href="#" aria-label="Previous"><span aria-hidden="true">&laquo;</span></a>';
		pagination.appendChild(prev);
		
		for (var i = 1; i <= totalPages; i++) {
		var pageItem = document.createElement('li');
		pageItem.className = 'page-item' + (i === currentPage ? ' active' : '');
		pageItem.innerHTML = '<a class="page-link" href="#">' + i + '</a>';
		pageItem.addEventListener('click', (function(page) {
		return function() {
		currentPage = page;
		showPage(page);
		setupPagination();
		}
		})(i));
		pagination.appendChild(pageItem);
		}
		
		var next = document.createElement('li');
		next.className = 'page-item';
		next.innerHTML = '<a class="page-link" href="#" aria-label="Next"><span aria-hidden="true">&raquo;</span></a>';
		pagination.appendChild(next);
		
		prev.addEventListener('click', function() {
		if (currentPage > 1) {
		currentPage--;
		showPage(currentPage);
		setupPagination();
		}
		});
		
		next.addEventListener('click', function() {
		if (currentPage < totalPages) {
		currentPage++;
		showPage(currentPage);
		setupPagination();
		}
		});
		}
		
		showPage(currentPage);
		setupPagination();
		});
		
		</script>
	</body>
</html>
